$SourcePath="@CMAKE_CURRENT_SOURCE_DIR@"
$TargetPath="@CMAKE_CURRENT_BINARY_DIR@"

$InstallerPath="$TargetPath/installer"
$InstallerData="$InstallerPath/data"
$InstallerMeta="$InstallerPath/meta"

# Create output directory
New-Item -Force -Path $InstallerData -ItemType "directory"

# Copy application resources
Copy-Item -Force -Recurse $SourcePath/dat/config $InstallerData
Copy-Item -Force -Recurse $SourcePath/dat/drivers $InstallerData
Copy-Item -Force -Recurse $SourcePath/dat/firmware $InstallerData

# Copy installer resources
Copy-Item -Force -Recurse $SourcePath/dat/resources $InstallerMeta

# Copy required DLLs
Copy-Item -Force $SourcePath/dll/airspy/x86_64/bin/*.dll $InstallerData
Copy-Item -Force $SourcePath/dll/airspy/x86_64/bin/*.dll $InstallerData
Copy-Item -Force $SourcePath/dll/hydrasdr/x86_64/bin/*.dll $InstallerData
Copy-Item -Force $SourcePath/dll/openssl/x86_64/bin/*.dll $InstallerData
Copy-Item -Force $SourcePath/dll/rtlsdr/x86_64/bin/*.dll $InstallerData
Copy-Item -Force $SourcePath/dll/usb/x86_64/bin/*.dll $InstallerData
Copy-Item -Force $TargetPath/src/nfc-app/app-qt/nfc-lab.exe $InstallerData

# Create QT deployment from executable
windeployqt --verbose 1 --force --compiler-runtime --no-translations --no-system-d3d-compiler --no-opengl-sw $InstallerData/nfc-lab.exe

# Create QT installer
makensis $InstallerMeta/script.nsi
